# AI会话交接文档

**目标读者**: 下一个AI会话  
**阅读时间**: 5分钟  
**最后更新**: 2025年10月10日

---

## 🚦 快速开始（3步）

### 1. 了解项目 (2分钟)

这是一个**俄罗斯方块游戏**，特色是：
- 像素块独立下落（三方向：下、左下、右下）
- 同色像素块横跨左右边界时消除
- MVP已完成，核心玩法完全可玩 ✅

### 2. 运行游戏 (1分钟)

```bash
npm install
npm run dev
# 浏览器打开 http://localhost:3001
# 点击槽位 → 拖动 → 放置 → 观察下落和消除
```

### 3. 阅读关键文档 (2分钟)

- **[PROJECT_CONTEXT.md](PROJECT_CONTEXT.md)** ⭐ 必读
- **[docs/GameDesignDocument.md](docs/GameDesignDocument.md)** 的"核心技术要点"部分

---

## ⚠️ 关键警告（必须知道的坑）

### 1. 消除判定必须在像素网格层面BFS

❌ **错误**：在逻辑网格（12×22）BFS  
✅ **正确**：在像素网格（120×220）BFS

**原因**：三角形堆积导致逻辑层断连

**位置**：`src/gameplay/Elimination.ts` → `findPixelClusters()`

### 2. 消除时必须删除BFS返回的像素块引用

❌ **错误**：通过逻辑坐标重新查找  
✅ **正确**：直接删除BFS返回的像素块数组

**原因**：像素块可能滑到逻辑格子外

**位置**：`src/gameplay/Elimination.ts` → `eliminatePixels()`

### 3. 稳定性检查必须循环进行

❌ **错误**：消除后只检查一次  
✅ **正确**：循环检查直到没有新的不稳定像素块

**原因**：像素块逐层失去支撑

**位置**：`src/scenes/GameScene.ts` → `gameLoop()` 自动循环

### 4. 只计算稳定像素块作为支撑

❌ **错误**：不稳定的像素块也算支撑  
✅ **正确**：只有已稳定的像素块才能提供支撑

**原因**：不稳定的会移走

**位置**：`src/core/PhysicsManager.ts` → `hasRealSupportBelow()`

---

## 📁 项目结构

```
src/
├── core/           # 核心系统（Grid, Physics, Tetromino, GameState）
├── gameplay/       # 玩法逻辑（DragDrop, Elimination, Scoring, Slots）
├── rendering/      # 渲染（PixelRenderer）
└── scenes/         # 场景（GameScene 组合一切）
```

**代码行数**: 约2,500行TypeScript  
**代码质量**: 0错误，0警告 ✅

---

## ✅ 已完成功能

- ✅ 三方向下落物理（完美）
- ✅ 拖放操作（绿/红反馈）
- ✅ 消除系统（像素层BFS）
- ✅ 自动稳定性检查（无残留）
- ✅ 连锁反应
- ✅ 计分系统
- ✅ 游戏结束判定

---

## ⏳ 待实现功能

1. **消除动画** (优先级: 高)
2. **音效系统** (优先级: 高)
3. **SDK集成** (优先级: 中)
4. **性能优化** (优先级: 低)

---

## 🐛 已解决的5个关键Bug

| Bug | 症状 | 根本原因 | 难度 |
|-----|------|---------|------|
| 消除判定失败 | 视觉连续不消除 | 逻辑网格BFS | ⭐⭐⭐⭐⭐ |
| 像素块残留 | 消除后有悬空 | 逻辑坐标删除 | ⭐⭐⭐⭐ |
| 活跃数量爆炸 | 数量从100→1000+ | 级联检查 | ⭐⭐⭐⭐ |
| 下落缓慢 | 一层一层下落 | 互相阻挡 | ⭐⭐⭐⭐⭐ |
| 槽位不一致 | 显示和拖动不同 | 补充时机错误 | ⭐⭐⭐ |

详情见 [DEVELOPMENT_LOG.md](DEVELOPMENT_LOG.md)

---

## 🔧 调试工具

游戏中按键：
- **G键**: 显示网格状态
- **R键**: 手动触发重力检查
- **ESC键**: 取消拖动

---

## 📚 文档索引

### 按阅读顺序

1. **AI_HANDOFF.md** (本文件) - 5分钟快速了解
2. **PROJECT_CONTEXT.md** - 完整项目上下文
3. **docs/GameDesignDocument.md** - 完整设计（重点：开头+第8章）
4. **ARCHITECTURE.md** - 技术架构
5. **DEVELOPMENT_LOG.md** - 开发历程

### 按用途

- **快速上手**: QUICK_START.md
- **设计问题**: docs/GameDesignDocument.md
- **实现问题**: PROJECT_CONTEXT.md → "已解决的关键问题"
- **架构问题**: ARCHITECTURE.md
- **Bug诊断**: 设计文档附录F "常见错误日志识别"

---

## 🎯 如果你要...

### 继续开发新功能

1. 查看 README.md "开发进度" 部分
2. 选择一个待实现功能
3. 参考现有代码风格
4. 添加调试日志
5. 测试验证

### 修复Bug

1. 复现问题
2. 按G键查看状态
3. 查看控制台日志
4. 参考 "已解决的5个关键Bug"
5. 参考设计文档附录F

### 理解代码

1. 阅读 ARCHITECTURE.md
2. 查看数据流图
3. 从 GameScene.ts 开始追踪
4. 使用VSCode的"转到定义"功能

### 重构代码

**❌ 不建议重构核心系统**

当前架构经过充分验证，核心系统（Grid, Physics, Elimination）不应该重构。

如果必须重构，请：
1. 理解为什么要这样设计
2. 参考 "已解决的关键Bug"
3. 确保不会重蹈覆辙

---

## 💬 重要提醒

### 设计文档已修正

设计文档从 **4.1版本升级到5.0版本**，修正了关键错误：
- ✅ 消除判定改为像素层BFS
- ✅ 添加了稳定性循环检查说明
- ✅ 添加了"AI开发常见陷阱"附录

**旧版本（4.1）的部分内容是错误的**，请以5.0版本为准。

### 代码即文档

当设计文档和代码不一致时，**以代码为准**。

代码已经经过充分测试和验证，是正确的实现。

### 保持代码质量

当前代码：
- 0 TypeScript错误
- 0 Linter警告
- 完整的注释
- 详细的调试日志

请保持这个标准！

---

## 🎉 祝你成功！

这是一个设计精良、实现扎实的项目。核心系统已经完美，继续开发应该很顺利。

遇到问题时：
1. **先查文档** - 可能已经有解决方案
2. **看日志** - 日志会告诉你发生了什么
3. **小步迭代** - 每次只改一点，立即测试
4. **保持冷静** - 所有bug都是可以解决的

**Good luck!** 🚀

---

**P.S.** 如果你修复了新的bug或添加了新功能，请更新相关文档，让下一个AI会话也能受益！

